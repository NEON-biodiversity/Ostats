---
title: "Ostats"
author: 'Arya Yue, Quentin Read, Isadora Essig Fluck, Ben Baiser, Sydne Record'
date: '`r Sys.Date()`'
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Ostats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Overview

The study of functional traits in ecology enables a greater understanding of the mechanisms underlying patterns of biodiversity. While trait-based research has traditionally focused on mean trait values for a species, there is growing awareness of the need to pay greater attention to intraspecific trait variation (ITV; Violle et al. 2012). From an evolutionary standpoint, ITV is important because it reflects differences within a species on which natural selection acts, and ecologically these differences within and among species in traits may give rise to differences in species interactions (Bolnick et al. 2011, Read et al. 2018).

When ITV is taken into account, trait values of individuals of each species may be portrayed as a distribution rather than as a single mean value. The degree of trait similarity between species can be measured as the amount of overlap in trait space between all species pairs in a community. Lower overlap indicates greater trait partitioning between pairs of species in a community. The Ostats package calculates a statistic to measure the degree of community-level trait overlap by fitting nonparametric kernel density functions to each species’ trait distribution
and calculating their areas of overlap (Mouillot et al. 2005, Geange et al. 2011, Read et al. 2018). The median pairwise overlap for a community is calculated by first determining the overlap of each species pair in trait space, and then taking the median overlap of each species pair in a community. Functions in this package can be used to assess the level of species trait overlap and compare across communities. Effect size statistics can also be calculated against local or regional null models.

***

The Ostats package consists of 10 functions in total. Some of the most common ways to use them are:

  * Calculating overlap statistics against a local null model using *Ostats*, which depends on *community_overlap_merged*, which calculates a community overlap value using one of the three pairwise overlap functions, and *get_ses*. *Ostats* is capable of processing both linear and circular (time, angles, etc) data.

  * *Ostat2longform* converts the output of *Ostats* to a table in long form.

  * Calculating overlap statistics against a regional null model when there is a regional dataset available, using *Ostats_regional* which depends on *pairwise_overlap* and *get_ses*. 

  * The plotting function *Ostats_plot* is used to produce a visual display of species trait overlap in each community. 

  * *community_overlap_noitv* calculates a value for each community that reflects pairwise distances using means of traits for each species, not taking intraspecific variation into account.

# Step-by-step Tutorials

## Overlap statistics for linear data against a local null model

The function *Ostats* is the primary function in this package.This function first generates density estimates for species trait distributions and calculates the intersection of two density functions to produce pairwise overlap values using *pairwise_overlap*, then evaluates a community overlap value from the pairwise overlap values of all species pairs in the community using *community_overlap_merged*, and lastly compares the community overlap value to a null model to calculate effect size statistics.

The input of the function *Ostats* is taken from a dataset with a column for species identification, a column that indicates which community the individual belongs to, and a column with trait measurements, often log-transformed. 

### An example using *Ostats* at default

A sample dataset is shown below, used to calculate the Overlap statistics for sites 'HARV' and 'JORN' from the National Ecological Observatory Network (NEON) (Read et al., 2018).

```{r include=FALSE}
library(Ostats)
library(tidyverse)
 
 # Load data from web archive
 dat <- read_csv('https://ndownloader.figshare.com/files/9167548')

 # Keep only sites "HARV" and "JORN", and the relevant columns required by the function.
 # add a new column named "log_weight" to log-transform the measurements.

 dat <- dat %>%
   filter(siteID %in% c('HARV','JORN')) %>%
   select(siteID, taxonID, weight) %>%
   filter(!is.na(weight)) %>%
   mutate(log_weight = log10(weight))
 
 # group the data by siteID and taxonID and look at the summary 
 dat %>%
   group_by(siteID, taxonID) %>%
   slice(1)

```

The input dataset looks like this, arranged by siteID and taxonID:
```{r}
 head(dat)
```

The running of the function can take some time, depending on the size of the dataset and null model generation. A progress bar is provided to enable close monitoring.


```{r echo = T, results='hide'}
 #Run O-stats on the data with everything at default
 Ostats_example <- Ostats(traits = as.matrix(dat[,'log_weight']),
                    sp = factor(dat$taxonID),
                    plots = factor(dat$siteID),
                    data_type = "linear")
```


```{r}
# the output of the function Ostats
summary(Ostats_example)
```

The result of Ostats is a list containing the following items:

*overlaps_norm*: a matrix showing community overlap value for each community with the area under all density functions normalized to 1.
*overlaps_unnorm*: a matrix showing community overlap value for each community with the area under all density functions proportional to the number of observations in that group.

These are community overlap values for each community, with 1 indicating complete overlap and 0 indicating no overlap. A higher value means greater overlap among species trait distributions. The difference between *overlaps_norm* and *overlaps_unnorm* is that *overlaps_norm* does not take species abundance into account.

In addition, the effect size statistics are also calculated and displayed:

*overlaps_norm_ses*: 5 matrices of effect size statistics against a null model with the area under all density functions normalized to 1.
*overlaps_unnorm_ses*: 5 matrices of effect size statistics against a null model with the area under all density functions proportional to the number of observations in that group.

The effect size values are used to compare the observed overlap statistics with a local null model (z-score test). The upper and lower limits are set as 95% at default, and if the ses (standard effect sizes) value is lower than the lower limit for that community, it suggests that the community overlap value observed is lower than expected by chance from a null model. Similarly, if the community overlap value is higher than the upper limit, the community has a higher overlap than expected.


```{r}
Ostats_example
```

By examining the output of the the *Ostats* function, we could see that the site 'HARV' has a high community overlap value and 'JORN' has a very low community overlap value by looking at *overlaps_norm* and *overlaps_unnorm*. In both of the norm and unnorm scenarios, by comparing these values to the raw upper and raw lower values (or ses values to ses lower and upper limits) for each site, the community overlap of 'HARV' falls within the range, suggesting that the overlap value is expected by the null model. On the other hand, 'JORN' has a much lower value than the lower limit, emphasizing this decreased community overlap.

### Arguments for the function *Ostats*

In the above example, the argument *data_type* = "linear", as the data processed is linear. Other arguments with default inputs are:

*output* = "median" and *weight_type*= "hmean", which means that the function calculates the median of pairwise overlaps of trait distributions of all species in each community, weighted by harmomic means of abundances of the species pairs is calculated as overlap value for the whole community. The default is set as such to minimize the effect of outliners and rare species.If the argument weight_type = "none", no weights are used for the calculation of mean/median. If weight_type = "mean", arithmetic means of abundances are used as weights. To change the output to mean, specify the argument output = "mean".

```{r echo = T, results='hide'}
# example of specifying the arguments output and weight_type

Ostats_example2 <- Ostats(traits = as.matrix(dat[,'log_weight']),
                    sp = factor(dat$taxonID),
                    plots = factor(dat$siteID),
                    data_type = "linear",
                    output = "mean",
                    weight_type = "none")

```


The argument *nperm* sets the number of permutations, or randomly generated "fake" detasets, for the null model. The default number is 99. 

The argument *nullqs* sets the limit boundaries for effect size statistics calculation, and the default effect size quantiles is the middle 95%, which is *nullqs* = c(0.025, 0.975). This argument should be a numeric vector of probabilities with values in [0,1].

At default, *shuffle_weights* = FALSE and *swap_means* = FALSE, and the null model is generated by randomly assigning a taxon that is present in the community to each individual. To change the way of null model generation, the user can make use of these to arguments. If *shuffle_weights* is TRUE, the *Ostats* function shuffles weights given to pairwise overlaps within a community when generating null models. If *swap_means* is TRUE, swap means of body sizes within a community.

The *density_args* is an argument for the user to add any additional arguments to pass to \code{\link[stats]{density}}, such as \code{bw}, \code{n}, or \code{adjust}. If none are provided, default values are used.


```{r eval=FALSE}
# example of specifying the arguments for making density estimates

Ostats_example3 <- Ostats(traits = as.matrix(dat[,'log_weight']),
                    sp = factor(dat$taxonID),
                    plots = factor(dat$siteID), 
                    density_args=list(bw = 'nrd0', adjust = 2, n=200))

```

## Overlap statistics for circular data against a local null model

The function *Ostats* can also be used to calculate overlap statistics of circular data, such as angular data like direction and orientation, or time. Two different kinds of circular calculations are available: one is to use \code{\link[circular]{circular}} embedded in the function *circular_overlap* to calculate density estimates, when the data is continuous; the other is to manually calculate the density by taking the proportion of each hour using the function *circular_overlap_24hour*, when the data is circular but only collected hourly, making it discrete data.

According to the type of data analyzed, the user can set the argument data_type = "circular" when the data is continuous, and data_type = "circular_discrete" if the data is collected every hour.

Below is an example using ant_data and the *Ostats* function to calculate overlap statistics. The input data is a record of ants in two chambers and their time of occurrence.

```{r}
# the input data
head(ant_data)
```


```{r echo = T, results='hide'}
# an example to calculate overlap statistics for hourly data using ant_data dataset in the Ostats package

circular_example <- Ostats(traits = as.matrix(ant_data$time),
                    sp = factor(ant_data$species),
                    plots = factor(ant_data$chamber),
                    data_type = "circular_discrete")

```

The arguments and the structure of the output is the same as linear data calculation.

For continous circular data, data_type = "circular" is used, and *circular_args* can be used to pass additional arguments to \code{\link[circular]{circular}}.

## Converting the output of *Ostats* to a table in long form.

*Ostat2longform* can convert the output of *Ostats* to a long-form table for further analysis.

```{r eval=FALSE}
#To preserve column names, when using *Ostats*, the input argument *traits* should be dat[,'log_weight'] instead of dat$log_weight for *Ostat2longform* to work.

Ostat2longform(Ostats_example)
```

## Overlap Statistics for linear data against a regional null model 

*Ostats_regional* is a function that calculates overlap statistics against a regional null model, if the user has another dataset with trait measurements for the regional species pool. The null model is generated by randomly sampling data from the regional species pool.

In the example below, the sample dataset *reg_pool* is used as a regional pool dataset across space and time. Each row represents an individual small mammal that was trapped and weighed, with its species identity and body mass in grams. The weight measurements have already been log-transformed. It includes small mammal capture records for two NEON sites Bartlett (BART) and Harvard Forest (HARV) from 2013 to 2019. Data for these two sites can be used as regional data because both sites are from the same ecoclimatic domain classified by NEON (the Northeast Domain).

```{r}
head(reg_pool)
```

Assuming the small mammal data at 'HARV' and 'BART' in 2019 are the newly observed data to be compared to the whole regional pool. 

The user needs to note that the reg_pool_traits should be a list of datasets, each corresponding to the regional pool for each community. In this example, as the sites 'HARV' and 'BART' share the same regional pool, reg_pool is used twice.

```{r echo = T, results='hide'}
# getting the 2019 data for 'HARV' and 'BART'
 sites2019 <- reg_pool %>%
 filter(siteID =='HARV'|siteID == 'BART') %>%
 filter(substring(as.character(endDate),1,4)=="2019")

 # Overlap statistics against the overall data (HARV and BART, sites from the same domain,     across all available years) 
 
 reg_pool_traits <- list (as.matrix(reg_pool$log_weight), as.matrix(reg_pool$log_weight))
 reg_pool_sp <- list(as.matrix(reg_pool$taxonID), as.matrix(reg_pool$taxonID))
 names(reg_pool_traits) <- c("HARV", "BART")
 names(reg_pool_sp) <- c("HARV", "BART")
 
 Ostats_reg_example <- Ostats_regional(traits = as.matrix(sites2019$log_weight),
                                      plots = factor(sites2019$siteID),
                                      sp = factor(sites2019$taxonID),
                                      reg_pool_traits = reg_pool_traits,
                                      reg_pool_sp = reg_pool_sp)
```

The function takes all individual trait measurements in each community to compare with its regional pool (ignoring species identity) to calculate pairwise overlap for each community, which indicates the the size of the regional pool space a community takes up. 

Effect size statistics are calculated against a total-pool null model and a by-species null model respectively. Total-pool null model is generated by sampling n trait measurements (n = number of trait measurements for the community) from the regional pool and calculate the pairwise overlap between the random sample and the regional pool. By-species null model is calculated by sampling trait measurements of the same species from the regional pool for each species present in the community to calculate pairwise overlap between the sample and the whole regional pool.

```{r}
Ostats_reg_example

```
The output of the function Ostats_regional is similar to that of Ostats function, with a list containing overlaps_reg, standard effect size statistics for total-pool null model and for by-species null model.

In this function, the area under all density functions are normalized to 1. In other words, norm = TRUE is applied without the option of taking species abundances into account,  which is more appropriate if the species abundances vary too much.

Other arguments are similar in use to the same arguments in *Ostats*. The user can customize *nperm*, *nullqs*, and pass arguments to *density()* function in *pairwise_overlap*.

Ostats_regional so far only supports linear data calculation.

## Overlap plots

The graphing function *Ostats_plot* depended on ggplot2 can be used to graph species trait overlaps of each community for multiple communities. 

The input dataset indiv_dat needs to have at least three columns: one for taxon identification, one for trait measurements, and one to indicate which community the individual belongs to.

Overlap_dat is the output of Ostats function for the same data. It is used to label the graphs with community overlap values.


```{r}
# example using the NEON small mammal dataset and Ostats_example

#indiv_dat <- read_csv('https://ndownloader.figshare.com/files/9167548', col_names = T)

#Ostats_plot(indiv_dat = indiv_dat, siteID = indiv_dat$siteID, taxonID = indiv_dat$taxonID, trait = indiv_dat$logweight, overlap_dat = Ostats_example, sites2use = c('HARV','JORN'),adjust_o = 1.5, name_x = 'Body Weight (log-transformed)')

```

If *site2use* = NULL, the function plots for all communities.

The argument *n_col Number* can be used to change number of columns for layout of individual panels. Default is 3.

*colorvalues* is a vector of color values for the density polygons. Defaults to a viridis palette if none provided.

*alpha_o* defines the colors trasparency level for the density polygons. Default is 0.5
adjust_o* multiplicate the bandwidth adjustment of the density polygons. The less, the tiny your density polygons will be. Default is 2.

*limits_o* the limits (min and max values) of the x axis. Default is \code{c(0.5*min(trait,na.rm=TRUE), 1.5*max(trait,na.rm=TRUE))}

*name_x* is a character indicating the name of your x axis (i.e. the name of your trait). Default is 'Trait value'.
*name_y* is a character indicating the name of your y axis. Default is 'Probability Density'.

If the graphs do not look normal, check whether the trait measurements have been log-transformed. 

## Pairwise distances and plots

*community_overlap_noitv* calculates a value for each community that reflects pairwise distances using means of traits for each species, not taking intraspecific variation into account.

# Bibliography 

Read et al. (2018). Among-species overlap in rodent body size distributions predicts species richness along a temperature gradient. Ecography, 41(10), 1718–1727. https://doi.org/10.1111/ecog.03641


Violle et al. (2012). The return of the variance: Intraspecific variability in community ecology. Trends in Ecology & Evolution, 27(4), 244–252. https://doi.org/10.1016/j.tree.2011.11.014
